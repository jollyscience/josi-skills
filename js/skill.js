// Generated by CoffeeScript 1.6.3
(function(){var e,t,n;e=require("./promises");n=require("hubot").TextMessage;t=function(){function t(e,t){this.namespace=e;t.logger.info("New Skill!",this.namespace);this}t.prototype.backFlag="back";t.prototype.killFlag="kill";t.prototype.start=function(e,t){var n;try{return this.converse(e,t)}catch(r){n=r;n.locale="Skill.start()";throw n}};t.prototype.converse=function(t,n){var r,i;try{i=new e.Promise;this.thisTime(t,n);this.nextTime(t,n,i);return i}catch(s){r=s;r.locale="Skill.converse()";throw r}};t.prototype.thisTime=function(e,t){var n,r,i,s;try{n=e.steps[e.step];(i=n.echo)&&this.echo(i,t);if(s=n.exec)return this.exec(s,t)}catch(o){r=o;r.locale="Skill.thisTime()";throw r}};t.prototype.nextTime=function(e,t,n){var r,i,s,o;try{r=e.steps[e.step];e.step===this.backFlag&&(e.step=e.cache);e[this.killFlag]=e.step[this.killFlag]||!1;if(e[this.killFlag]){n.resolve(t.message);return}if(((o=r.expect)!=null?o.pass:void 0)==null)delete r.expect;else{r.expect.fail=r.expect.fail||"fail";t.chatty("c: "+e.step+", p: "+r.expect.pass+", f: "+r.expect.fail)}return(s=r.expect)?this.expect(s,t,n,e):r.step==="fail"?n.reject(t.message):n.resolve(t.message)}catch(u){i=u;i.locale="Skill.nextTime()";throw i}};t.prototype.expect=function(e,t,n,r){var i,s;try{s=this;i=new RegExp(e.respond.toString(),"i");t.chatty("(expecting... "+i+")");return t.expect(i).done(function(e){return s.pass(r,t,e,n)}).fail(function(e){return s.fail(r,t,e,n)})}catch(o){i=o;i.locale="Skill.expect()";throw i}};t.prototype.pass=function(e,t,n,r){var i;try{e.last=e.step;e.step=e.steps[e.step].expect.pass;return this.converse(e,t)}catch(s){i=s;i.locale="Skill.pass()";throw i}};t.prototype.fail=function(e,t,n,r){var i,s;try{s=e.steps[e.step].expect.fail;e.steps[s].expect.pass===this.backFlag&&(e.cache=e.step);if(/back/i.test(n.text))return this.back(e,t);if(e.step=s){t.robot.logger.info("going again!");return this.converse(e,t)}t.robot.logger.info("done!");return r.reject(n)}catch(o){i=o;i.locale="Skill.fail()";throw i}};t.prototype.back=function(e,t){var n;try{e.step=e.last;return this.converse(e,t)}catch(r){n=r;n.locale="Skill.back()";throw n}};t.prototype.echo=function(t,n){var r,i;try{i=new e.Promise;if(t&&n){n.send(t);i.resolve(n.message)}else i.reject(n.message);return i}catch(s){r=s;r.locale="Skill.echo()";throw r}};t.prototype.exec=function(t,r){var i,s,o;try{s=new e.Promise;if(o=new n(r.message.user,""+r.robot.name+": "+t)){r.robot.receive(o);s.resolve(r.message)}else s.reject(r.message);return s}catch(u){i=u;i.locale="Skill.exec()";throw i}};return t}();module.exports=t}).call(this);